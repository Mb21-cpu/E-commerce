{% extends "base.html" %}

{% block title %}Finalizar Compra{% endblock %}

{% block content %}
<div class="checkout-container">
    <h1 class="text-4xl font-extrabold text-indigo-700 text-center mb-10 border-b-2 border-indigo-100 pb-4">
        Finalizar Compra
    </h1>

    {% if messages %}
        <div class="mb-6 max-w-4xl mx-auto">
            {% for message in messages %}
                <div class="p-4 mb-3 rounded-xl shadow-md font-medium
                    {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300
                    {% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300
                    {% else %}bg-blue-100 text-blue-700 border border-blue-300
                    {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if cart_items %}
    <div class="checkout-grid">

        <!-- Sección de Resumen del Carrito (order-2 en móvil, order-1 en desktop) -->
        <section class="cart-summary-section">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-5 border-b pb-3 border-gray-200">
                Resumen del Carrito
            </h2>
            <div class="summary-details">
                {% for item in cart_items %}
                    <div class="summary-item">
                        <span class="item-name">{{ item.name }}</span>
                        <div class="item-info">
                            <span class="item-quantity">Cant: {{ item.quantity }}</span>
                            <!-- Se muestra el total del ítem para claridad -->
                            <span class="item-price">${{ item.total|floatformat:2 }}</span>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="cart-total-footer">
                <div class="flex justify-between text-lg text-gray-700 mb-2">
                    <p>Subtotal:</p>
                    <p class="font-medium">${{ subtotal|floatformat:2 }}</p>
                </div>
                <div class="flex justify-between text-lg text-gray-700 mb-4">
                    <p>Costo de Envío:</p>
                    <p class="font-medium">${{ shipping_fee|floatformat:2 }}</p>
                </div>
                <div class="border-t-2 border-dashed border-indigo-200 pt-4 mt-4">
                    <div class="flex justify-between text-2xl font-extrabold text-indigo-700">
                        <p>Total a Pagar:</p>
                        <p>${{ cart_total|floatformat:2 }}</p>
                    </div>
                </div>
            </div>

            <p class="text-sm text-gray-500 mt-6 text-center">
                El pago se gestiona en la plataforma segura de Stripe.
            </p>
        </section>

        <!-- Sección del Formulario de Envío (order-1 en móvil, order-2 en desktop) -->
        <section class="checkout-form-section">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-5 border-b pb-3 border-gray-200">
                Datos del Comprador y Envío
            </h2>
            <form method="post" action="{% url 'checkout' %}" class="checkout-form">
                {% csrf_token %}

                <!-- Campo de Email (Solo visual, ya lo tiene el usuario logueado) -->
                <div class="form-group">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" id="email" name="email" value="{{ request.user.email }}"
                           disabled
                           class="form-control bg-gray-100 cursor-not-allowed"
                           placeholder="Correo electrónico">
                </div>

                <!-- Campo de Dirección de Envío -->
                <div class="form-group">
                    <label for="address" class="form-label">Dirección de Envío Completa:</label>
                    <textarea
                        id="address"
                        name="address"
                        rows="4"
                        required
                        class="form-control"
                        placeholder="Ej: Calle Falsa 123, Apto 5B, Ciudad, País, Código Postal.">{% if user.address %}{{ user.address }}{% endif %}</textarea>
                </div>

                <!-- Botón de Pago que inicia la sesión de Stripe -->
                <button
                    type="submit"
                    class="checkout-btn">
                    Confirmar Datos e Ir a Pagar (${{ cart_total|floatformat:2 }})
                </button>
            </form>
        </section>
    </div>
    {% else %}
        <div class="text-center p-10 bg-white rounded-xl shadow-xl max-w-xl mx-auto mt-10">
            <p class="text-2xl text-gray-600 mb-6">Tu carrito está vacío.</p>
            <a href="{% url 'product_list' %}" class="text-indigo-600 hover:text-indigo-800 font-bold text-lg transition duration-150">
                &larr; Volver al Catálogo
            </a>
        </div>
    {% endif %}
</div>

<!-- Custom Tailwind CSS Configuration (as if it were custom CSS) -->
<style>
    /* Estilos globales basados en tu configuración original */
    body {
        background-color: #f7f9fc; /* --background-color */
    }

    .checkout-container {
        padding: 40px 20px;
        max-width: 1200px;
        margin: auto;
    }

    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 40px;
        max-width: 1000px;
        margin: 0 auto;
    }

    @media (min-width: 1024px) { /* lg: breakpoint */
        .checkout-grid {
            grid-template-columns: 1.5fr 1fr; /* Más espacio para el formulario en desktop */
        }
    }

    .cart-summary-section, .checkout-form-section {
        background-color: #fff; /* --card-bg */
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        height: fit-content;
    }

    .summary-details {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f7f9fc; /* --background-color */
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0; /* --light-border */
    }

    .item-name {
        font-weight: 600; /* semibold */
        font-size: 1.05em;
        color: #333; /* --text-color */
    }

    .item-info {
        display: flex;
        gap: 20px;
        font-size: 0.9em;
        color: #666; /* --sub-text-color */
    }

    .item-price {
        font-weight: 700; /* bold */
        color: #3f51b5; /* --primary-color */
        font-size: 1.1em;
    }

    .form-label {
        font-weight: 600;
        display: block;
        margin-bottom: 8px;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-sizing: border-box;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #3f51b5; /* --primary-color */
        box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
    }

    .checkout-btn {
        width: 100%;
        padding: 15px;
        background-color: #3f51b5; /* --primary-color */
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.2em;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .checkout-btn:hover {
        background-color: #2a3c5a;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}
